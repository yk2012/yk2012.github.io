<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>【Vue源码】图解 diff算法 与 虚拟DOM-snabbdom-最小量更新原理解析-手写源码-updateChildren | Hello YK</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="来自尚硅谷的课程笔记-加入大量的注释以及大量改写，新增很多插图解释diff算法-第八章仔细说明了老师说的一些比较含糊的地方">
    
    <link rel="preload" href="/assets/css/0.styles.a1c5306a.css" as="style"><link rel="preload" href="/assets/js/app.aa55ed40.js" as="script"><link rel="preload" href="/assets/js/6.74f99adc.js" as="script"><link rel="preload" href="/assets/js/3.92880c3b.js" as="script"><link rel="preload" href="/assets/js/15.a493639f.js" as="script"><link rel="prefetch" href="/assets/js/10.ca21962a.js"><link rel="prefetch" href="/assets/js/11.1d735124.js"><link rel="prefetch" href="/assets/js/12.406dfa05.js"><link rel="prefetch" href="/assets/js/13.661391c5.js"><link rel="prefetch" href="/assets/js/14.0b0d5d26.js"><link rel="prefetch" href="/assets/js/16.14aae990.js"><link rel="prefetch" href="/assets/js/17.7b61da2a.js"><link rel="prefetch" href="/assets/js/18.5b48663c.js"><link rel="prefetch" href="/assets/js/19.ae12e38d.js"><link rel="prefetch" href="/assets/js/20.5666e026.js"><link rel="prefetch" href="/assets/js/21.207740e5.js"><link rel="prefetch" href="/assets/js/22.97bab120.js"><link rel="prefetch" href="/assets/js/23.79fbd862.js"><link rel="prefetch" href="/assets/js/24.847699ab.js"><link rel="prefetch" href="/assets/js/25.0c86b3ef.js"><link rel="prefetch" href="/assets/js/26.070fddd4.js"><link rel="prefetch" href="/assets/js/27.373f7a01.js"><link rel="prefetch" href="/assets/js/28.25ad73a9.js"><link rel="prefetch" href="/assets/js/29.1831b409.js"><link rel="prefetch" href="/assets/js/30.559b73c8.js"><link rel="prefetch" href="/assets/js/31.4e118e76.js"><link rel="prefetch" href="/assets/js/4.d07712da.js"><link rel="prefetch" href="/assets/js/5.ef829c4b.js"><link rel="prefetch" href="/assets/js/7.47687670.js"><link rel="prefetch" href="/assets/js/8.a80a7372.js"><link rel="prefetch" href="/assets/js/9.169f7c1f.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.0cbd6f70.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a1c5306a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">Hello YK </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/blog/" class="nav-link">博客</a></li><li class="nav-item"><a href="/writing/" class="nav-link">随笔</a></li><li class="nav-item"><a href="/digest/" class="nav-link">文摘</a></li><li class="nav-item"><a href="/tag/" class="nav-link">标签</a></li><li class="nav-item"><a href="https://weread.qq.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">阅读</a></li><li class="nav-item"><a href="http://ykang2020.gitee.io/clock/" target="_blank" rel="noopener noreferrer" class="nav-link external">时钟</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">Hello YK </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/blog/" class="nav-link">博客</a></li><li class="mobile-nav-item"><a href="/writing/" class="nav-link">随笔</a></li><li class="mobile-nav-item"><a href="/digest/" class="nav-link">文摘</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">标签</a></li><li class="mobile-nav-item"><a href="https://weread.qq.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">阅读</a></li><li class="mobile-nav-item"><a href="http://ykang2020.gitee.io/clock/" target="_blank" rel="noopener noreferrer" class="nav-link external">时钟</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        【Vue源码】图解 diff算法 与 虚拟DOM-snabbdom-最小量更新原理解析-手写源码-updateChildren
      </h1> <div class="post-meta"><div itemprop="publisher author" itemtype="http://schema.org/Person" itemscope="itemscope" class="post-meta-author"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-navigation"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg> <span itemprop="name">YK菌</span> <span itemprop="address">   in HeFei</span></div> <!----> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-532d3a9c><a href="/tag/Vue" data-v-532d3a9c><span data-v-532d3a9c>Vue</span></a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><blockquote><p>来自尚硅谷的课程笔记 课程链接 <a href="https://www.bilibili.com/video/BV1v5411H7gZ" target="_blank" rel="noopener noreferrer">尚硅谷邵山欢（考拉老师）Vue之虚拟DOM和diff算法<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
加入大量的注释以及大量改写，新增很多插图解释diff算法
第八章仔细说明了老师说的一些比较含糊的地方
源码链接 <a href="https://gitee.com/ykang2020/vue_learn" target="_blank" rel="noopener noreferrer">https://gitee.com/ykang2020/vue_learn<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h2 id="_0-文章结构预览"><a href="#_0-文章结构预览" class="header-anchor">#</a> 0. 文章结构预览</h2> <p><img src="https://img-blog.csdnimg.cn/20210412141140612.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDk3MjAwOA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> <h3 id="_0-1-虚拟dom如何被渲染函数-h函数-产生"><a href="#_0-1-虚拟dom如何被渲染函数-h函数-产生" class="header-anchor">#</a> 0.1 虚拟DOM如何被渲染函数（h函数）产生</h3> <p>目标：手写h函数</p> <h3 id="_0-2-diff算法的原理"><a href="#_0-2-diff算法的原理" class="header-anchor">#</a> 0.2 diff算法的原理</h3> <p>目标：手写diff算法</p> <h3 id="_0-3-虚拟dom如何通过diff变成真正的dom"><a href="#_0-3-虚拟dom如何通过diff变成真正的dom" class="header-anchor">#</a> 0.3 虚拟DOM如何通过diff变成真正的DOM</h3> <h2 id="_1-介绍"><a href="#_1-介绍" class="header-anchor">#</a> 1. 介绍</h2> <h3 id="_1-1-diff算法"><a href="#_1-1-diff算法" class="header-anchor">#</a> 1.1 diff算法</h3> <p>精细化比较
<img src="https://img-blog.csdnimg.cn/20210412140606495.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDk3MjAwOA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> <h3 id="_1-2-虚拟dom"><a href="#_1-2-虚拟dom" class="header-anchor">#</a> 1.2 虚拟DOM</h3> <p>本课程不涉及<strong>DOM如何变成虚拟DOM</strong>
这属于模板编译原理范畴
但是<strong>虚拟节点变成DOM节点</strong>在diff中可以做到
<img src="https://img-blog.csdnimg.cn/20210412154812845.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDk3MjAwOA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> <h3 id="_1-3-关系-diff是发生在虚拟dom上的"><a href="#_1-3-关系-diff是发生在虚拟dom上的" class="header-anchor">#</a> 1.3 关系——diff是发生在虚拟DOM上的</h3> <p>新虚拟DOM和旧虚拟DOM进行diff(精细化比较)，算出应该如何最小量更新，最后反映到真正的DOM上</p> <p><img src="https://img-blog.csdnimg.cn/20210412155440459.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDk3MjAwOA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> <h2 id="_2-snabbdom-简介-及-准备工作"><a href="#_2-snabbdom-简介-及-准备工作" class="header-anchor">#</a> 2. snabbdom 简介 及 准备工作</h2> <h3 id="_2-1-简介"><a href="#_2-1-简介" class="header-anchor">#</a> 2.1 简介</h3> <p><code>snabbdom</code>(瑞典语，“速度”)是著名的虚拟DOM库，是diff算法的鼻祖
Vue源码借鉴了<code>snabbdom</code>
源码使用TypeScript写的<a href="https://github.com/snabbdom/snabbdom" target="_blank" rel="noopener noreferrer">https://github.com/snabbdom/snabbdom<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
从npm下载的是build出来的JavaScript版本</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>npm install <span class="token operator">-</span>D snabbdom
</code></pre></div><h3 id="_2-2-搭建初始环境"><a href="#_2-2-搭建初始环境" class="header-anchor">#</a> 2.2 搭建初始环境</h3> <h4 id="_1-安装snabbdom"><a href="#_1-安装snabbdom" class="header-anchor">#</a> 1. 安装snabbdom</h4> <div class="language-powershell extra-class"><pre class="language-powershell"><code>cnpm install <span class="token operator">-</span>S snabbdom
</code></pre></div><p><img src="https://img-blog.csdnimg.cn/2021041214225425.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDk3MjAwOA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> <h4 id="_2-安装webpack5并配置"><a href="#_2-安装webpack5并配置" class="header-anchor">#</a> 2. 安装webpack5并配置</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code>cnpm i <span class="token operator">-</span><span class="token constant">D</span> webpack@<span class="token number">5</span> webpack<span class="token operator">-</span>cli@<span class="token number">3</span> webpack<span class="token operator">-</span>dev<span class="token operator">-</span>server@<span class="token number">3</span>
</code></pre></div><p>配置webpack5</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// webpack5 不用配置mode</span>
  <span class="token comment">// 入口</span>
  entry<span class="token operator">:</span> <span class="token string">&quot;./src/index.js&quot;</span><span class="token punctuation">,</span>
  <span class="token comment">// 出口</span>
  output<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 虚拟打包路径，文件夹不会真正生成，而是在8080端口虚拟生成</span>
    publicPath<span class="token operator">:</span> <span class="token string">&quot;xuni&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">// 打包出来的文件名</span>
    filename<span class="token operator">:</span> <span class="token string">&quot;bundle.js&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 配置webpack-dev-server</span>
  devServer<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 静态根目录</span>
    contentBase<span class="token operator">:</span> <span class="token string">'www'</span><span class="token punctuation">,</span>
    <span class="token comment">// 端口号</span>
    port<span class="token operator">:</span> <span class="token number">8080</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_3-复制官方demo-example"><a href="#_3-复制官方demo-example" class="header-anchor">#</a> 3. 复制官方demo Example</h4> <p>src/index.js</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>
  init<span class="token punctuation">,</span>
  classModule<span class="token punctuation">,</span>
  propsModule<span class="token punctuation">,</span>
  styleModule<span class="token punctuation">,</span>
  eventListenersModule<span class="token punctuation">,</span>
  h<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;snabbdom&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> patch <span class="token operator">=</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token comment">// Init patch function with chosen modules</span>
  classModule<span class="token punctuation">,</span> <span class="token comment">// makes it easy to toggle classes</span>
  propsModule<span class="token punctuation">,</span> <span class="token comment">// for setting properties on DOM elements</span>
  styleModule<span class="token punctuation">,</span> <span class="token comment">// handles styling on elements with support for animations</span>
  eventListenersModule<span class="token punctuation">,</span> <span class="token comment">// attaches event listeners</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;container&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> vnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;div#container.two.classes&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> on<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token function-variable function">click</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
  <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;span&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> style<span class="token operator">:</span> <span class="token punctuation">{</span> fontWeight<span class="token operator">:</span> <span class="token string">&quot;bold&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;This is bold&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string">&quot; and this is just normal text&quot;</span><span class="token punctuation">,</span>
  <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> props<span class="token operator">:</span> <span class="token punctuation">{</span> href<span class="token operator">:</span> <span class="token string">&quot;/foo&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;I'll take you places!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Patch into empty DOM element – this modifies the DOM as a side effect</span>
<span class="token function">patch</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> newVnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span>
  <span class="token string">&quot;div#container.two.classes&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> on<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token function-variable function">click</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>
    <span class="token function">h</span><span class="token punctuation">(</span>
      <span class="token string">&quot;span&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> style<span class="token operator">:</span> <span class="token punctuation">{</span> fontWeight<span class="token operator">:</span> <span class="token string">&quot;normal&quot;</span><span class="token punctuation">,</span> fontStyle<span class="token operator">:</span> <span class="token string">&quot;italic&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">&quot;This is now italic type&quot;</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">&quot; and this is still just normal text&quot;</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> props<span class="token operator">:</span> <span class="token punctuation">{</span> href<span class="token operator">:</span> <span class="token string">&quot;/bar&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;I'll take you places!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Second `patch` invocation</span>
<span class="token function">patch</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> newVnode<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Snabbdom efficiently updates the old view to the new state</span>
</code></pre></div><p><img src="https://img-blog.csdnimg.cn/202104121523078.png" alt="在这里插入图片描述"></p> <h2 id="_3-h函数的介绍与使用"><a href="#_3-h函数的介绍与使用" class="header-anchor">#</a> 3. h函数的介绍与使用</h2> <h3 id="_3-1-介绍"><a href="#_3-1-介绍" class="header-anchor">#</a> 3.1 介绍</h3> <p>用来产生虚拟节点(vnode)
<img src="https://img-blog.csdnimg.cn/2021041216043170.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDk3MjAwOA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述">
虚拟节点vnode的属性</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">{</span>
	children<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token comment">// 子元素 数组</span>
	data<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// 属性、样式、key</span>
	elm<span class="token operator">:</span> <span class="token keyword">undefined</span> <span class="token comment">// 对应的真正的dom节点(对象)，undefined表示节点还没有上dom树</span>
	key<span class="token operator">:</span> <span class="token comment">// 唯一标识</span>
	sel<span class="token operator">:</span> <span class="token string">&quot;&quot;</span> <span class="token comment">// 选择器</span>
	text<span class="token operator">:</span> <span class="token string">&quot;&quot;</span> <span class="token comment">// 文本内容</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_3-2-使用h函数-创建虚拟节点"><a href="#_3-2-使用h函数-创建虚拟节点" class="header-anchor">#</a> 3.2 使用h函数 创建虚拟节点</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 创建虚拟节点</span>
<span class="token keyword">var</span> myVnode1 <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> props<span class="token operator">:</span> <span class="token punctuation">{</span> href<span class="token operator">:</span> <span class="token string">'https://www.baidu.com'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'YK菌'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myVnode1<span class="token punctuation">)</span>
</code></pre></div><p><img src="https://img-blog.csdnimg.cn/20210412161400494.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDk3MjAwOA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> <h3 id="_3-3-使用patch函数-将虚拟节点上dom树"><a href="#_3-3-使用patch函数-将虚拟节点上dom树" class="header-anchor">#</a> 3.3 使用patch函数 将虚拟节点上DOM树</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 创建patch函数</span>
<span class="token keyword">const</span> patch <span class="token operator">=</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  classModule<span class="token punctuation">,</span>
  propsModule<span class="token punctuation">,</span>
  styleModule<span class="token punctuation">,</span>
  eventListenersModule<span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 创建虚拟节点</span>
<span class="token keyword">var</span> myVnode1 <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span>
  <span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> props<span class="token operator">:</span> <span class="token punctuation">{</span> href<span class="token operator">:</span> <span class="token string">&quot;https://www.baidu.com&quot;</span><span class="token punctuation">,</span> target<span class="token operator">:</span> <span class="token string">&quot;_blank&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">&quot;YK菌&quot;</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 让虚拟节点上树</span>
<span class="token keyword">let</span> container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;container&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">patch</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> myVnode1<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://img-blog.csdnimg.cn/20210412162149109.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDk3MjAwOA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> <h3 id="_3-4-h函数嵌套使用-得到虚拟dom树-重要"><a href="#_3-4-h函数嵌套使用-得到虚拟dom树-重要" class="header-anchor">#</a> 3.4 h函数嵌套使用，得到虚拟DOM树（重要）</h3> <p><img src="https://img-blog.csdnimg.cn/20210412162603221.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDk3MjAwOA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> myVnode3 <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
  <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token string">'苹果'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token string">'香蕉'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token string">'西瓜'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token string">'番茄'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">// 让虚拟节点上树</span>
<span class="token keyword">let</span> container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;container&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">patch</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> myVnode3<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://img-blog.csdnimg.cn/20210412162923791.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDk3MjAwOA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> myVnode3 <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
  <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token string">'苹果'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
      <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">,</span> <span class="token string">'香蕉'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">,</span> <span class="token string">'草莓'</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span><span class="token string">'西瓜'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token string">'番茄'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="https://img-blog.csdnimg.cn/20210412163345417.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDk3MjAwOA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"> <img src="https://img-blog.csdnimg.cn/20210412163642392.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDk3MjAwOA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> <h2 id="_4-手写h函数"><a href="#_4-手写h函数" class="header-anchor">#</a> 4. 手写h函数</h2> <h3 id="vnode-js"><a href="#vnode-js" class="header-anchor">#</a> vnode.js</h3> <p>将传入的参数组合成对象返回</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">/**
 * 产生虚拟节点
 * 将传入的参数组合成对象返回
 * @param {string} sel 选择器
 * @param {object} data 属性、样式
 * @param {Array} children 子元素
 * @param {string|number} text 文本内容
 * @param {object} elm 对应的真正的dom节点(对象)，undefined表示节点还没有上dom树
 * @returns 
 */</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">sel<span class="token punctuation">,</span> data<span class="token punctuation">,</span> children<span class="token punctuation">,</span> text<span class="token punctuation">,</span> elm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> key <span class="token operator">=</span> data<span class="token punctuation">.</span>key<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span> sel<span class="token punctuation">,</span> data<span class="token punctuation">,</span> children<span class="token punctuation">,</span> text<span class="token punctuation">,</span> elm<span class="token punctuation">,</span> key <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="h-js"><a href="#h-js" class="header-anchor">#</a> h.js</h3> <p>产生虚拟DOM树，返回的是一个对象</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> vnode <span class="token keyword">from</span> <span class="token string">&quot;./vnode&quot;</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * 产生虚拟DOM树，返回的一个对象
 * 低配版本的h函数，这个函数必须接受三个参数，缺一不可
 * @param {*} sel
 * @param {*} data
 * @param {*} c
 * 调用只有三种形态 文字、数组、h函数
 * ① h('div', {}, '文字')
 * ② h('div', {}, [])
 * ③ h('div', {}, h())
 */</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">sel<span class="token punctuation">,</span> data<span class="token punctuation">,</span> c</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 检查参数个数</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>arguments<span class="token punctuation">.</span>length <span class="token operator">!==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;请传且只传入三个参数！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 检查第三个参数 c 的类型</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> c <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> c <span class="token operator">===</span> <span class="token string">&quot;number&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 说明现在是 ① 文字</span>
    <span class="token keyword">return</span> <span class="token function">vnode</span><span class="token punctuation">(</span>sel<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 说明是 ② 数组</span>
    <span class="token keyword">let</span> children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 遍历 c 数组</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> item <span class="token keyword">of</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> item <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">&amp;&amp;</span> item<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token string">&quot;sel&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;传入的数组有不是h函数的项&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 不用执行item, 只要收集数组中的每一个对象</span>
      children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">vnode</span><span class="token punctuation">(</span>sel<span class="token punctuation">,</span> data<span class="token punctuation">,</span> children<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> c <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">&amp;&amp;</span> c<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token string">&quot;sel&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 说明是 ③ h函数 是一个对象（h函数返回值是一个对象）放到children数组中就行了</span>
    <span class="token keyword">let</span> children <span class="token operator">=</span> <span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">vnode</span><span class="token punctuation">(</span>sel<span class="token punctuation">,</span> data<span class="token punctuation">,</span> children<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;传入的参数类型不对！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="index-js"><a href="#index-js" class="header-anchor">#</a> index.js</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> h <span class="token keyword">from</span> <span class="token string">&quot;./my_snabbdom/h&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> myVnode1 <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
  <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;p&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;嘻嘻&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;p&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;哈哈&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;p&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'呵呵'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myVnode1<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="效果展示"><a href="#效果展示" class="header-anchor">#</a> 效果展示</h3> <p><img src="https://img-blog.csdnimg.cn/20210412194521859.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDk3MjAwOA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> <h2 id="_5-手写diff算法准备"><a href="#_5-手写diff算法准备" class="header-anchor">#</a> 5. 手写diff算法准备</h2> <h3 id="_5-1-diff算法原理"><a href="#_5-1-diff算法原理" class="header-anchor">#</a> 5.1 diff算法原理</h3> <p>最小量更新，<code>key</code>很关键。<code>key</code>是这个节点的唯一标识，告诉diff算法，在更改前后它们是同一个DOM节点。</p> <p><strong>只是同一个虚拟节点，才进行精细化比较</strong>（往ul中的 li 添加 li），否则就是暴力删除旧的、插入新的（ul中的li 换到在 ol 中去）</p> <p>问题： 如何定义是同一个虚拟节点
答：<strong>选择器相同且key相同</strong></p> <p><strong>只进行同层比较，不会进行跨层比较</strong>。即使是同一片	虚拟节点，但是跨层了，diff就是暴力删除旧的，然后插入新的</p> <p><img src="https://img-blog.csdnimg.cn/20210413203439569.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDk3MjAwOA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> <p><img src="https://img-blog.csdnimg.cn/2021041220160893.png" alt="在这里插入图片描述"></p> <h3 id="_5-2-手写diff预备"><a href="#_5-2-手写diff预备" class="header-anchor">#</a> 5.2 手写diff预备</h3> <p><img src="https://img-blog.csdnimg.cn/20210412203424571.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDk3MjAwOA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> <h4 id="_5-2-1-源码中如何定义-同一个节点"><a href="#_5-2-1-源码中如何定义-同一个节点" class="header-anchor">#</a> 5.2.1 源码中如何定义“同一个节点”</h4> <p><img src="https://img-blog.csdnimg.cn/20210412203615676.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDk3MjAwOA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> <h4 id="_5-2-2-源码中创建子节点-需要递归"><a href="#_5-2-2-源码中创建子节点-需要递归" class="header-anchor">#</a> 5.2.2 源码中创建子节点，需要递归</h4> <p><img src="https://img-blog.csdnimg.cn/20210412225456960.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDk3MjAwOA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> <h2 id="_6-手写diff-首次上dom树patch-container-myvnode1"><a href="#_6-手写diff-首次上dom树patch-container-myvnode1" class="header-anchor">#</a> 6. 手写diff——首次上DOM树<code>patch(container, myVnode1)</code></h2> <h3 id="_6-0-dom-预备知识"><a href="#_6-0-dom-预备知识" class="header-anchor">#</a> 6.0 DOM 预备知识</h3> <h4 id="_6-0-1-node-insertbefore"><a href="#_6-0-1-node-insertbefore" class="header-anchor">#</a> 6.0.1 Node.insertBefore()</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> insertedNode <span class="token operator">=</span> parentNode<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>newNode<span class="token punctuation">,</span> referenceNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>insertedNode</code> ：被插入节点(<code>newNode</code>)
<code>parentNode</code> ：新插入节点的父节点
<code>newNode</code> ：用于插入的节点
<code>referenceNode</code>  ：<code>newNode</code> 将要插在这个节点之前
在当前节点下增加一个子节点 <code>Node</code>，并使该子节点位于参考节点的前面。</p> <h4 id="_6-0-2-node-appendchild"><a href="#_6-0-2-node-appendchild" class="header-anchor">#</a> 6.0.2 Node.appendChild()</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code>element<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>aChild<span class="token punctuation">)</span>
</code></pre></div><p>将一个节点附加到指定父节点的子节点列表的末尾处。
如果将被插入的节点已经存在于当前文档的文档树中，那么 <code>appendChild()</code> 只会将它从原先的位置移动到新的位置（不需要事先移除要移动的节点）。</p> <h4 id="_6-0-3-element-tagname"><a href="#_6-0-3-element-tagname" class="header-anchor">#</a> 6.0.3 Element.tagName</h4> <p>返回当前元素的标签名</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>elementName <span class="token operator">=</span> element<span class="token punctuation">.</span>tagName
</code></pre></div><p><code>elementName</code> 是一个字符串,包含了element元素的标签名.
在HTML文档中, <code>tagName</code>会返回其<strong>大写形式</strong></p> <h4 id="_6-0-4-node-removechild"><a href="#_6-0-4-node-removechild" class="header-anchor">#</a> 6.0.4 Node.removeChild</h4> <p>从DOM中删除一个子节点。返回删除的节点</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> oldChild <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//OR</span>

element<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>child</code> 是要移除的那个子节点.
<code>node</code> 是child的父节点.
<code>oldChild</code>保存对删除的子节点的引用. <code>oldChild === child.</code></p> <h4 id="_6-0-5-document-createelement"><a href="#_6-0-5-document-createelement" class="header-anchor">#</a> 6.0.5 document.createElement</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> element <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>tagName<span class="token punctuation">[</span><span class="token punctuation">,</span> options<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>tagName</code>：指定要创建<strong>元素类型</strong>的字符串, 创建元素时的 nodeName 使用 tagName 的值为初始化，该方法不允许使用限定名称(如:&quot;html:a&quot;)，在 HTML 文档上调用 createElement() 方法创建元素之前会将tagName 转化成小写，在 Firefox、Opera 和 Chrome 内核中，createElement(null) 等同于 createElement(&quot;null&quot;)
<code>返回</code> 新建的元素（Element）</p> <h3 id="_6-1-patch-js"><a href="#_6-1-patch-js" class="header-anchor">#</a> 6.1 patch.js</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> vnode <span class="token keyword">from</span> <span class="token string">&quot;./vnode&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> createElement <span class="token keyword">from</span> <span class="token string">&quot;./createElement&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token punctuation">,</span> newVnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 判断传入的第一个参数是 DOM节点 还是 虚拟节点</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>sel <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token operator">||</span> oldVnode<span class="token punctuation">.</span>sel <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 说明oldVnode是DOM节点，此时要包装成虚拟节点</span>
    oldVnode <span class="token operator">=</span> <span class="token function">vnode</span><span class="token punctuation">(</span>
      oldVnode<span class="token punctuation">.</span>tagName<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// sel</span>
      <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// data</span>
      <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// children</span>
      <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token comment">// text</span>
      oldVnode <span class="token comment">// elm</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 判断 oldVnode 和 newVnode 是不是同一个节点</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>key <span class="token operator">===</span> newVnode<span class="token punctuation">.</span>key <span class="token operator">&amp;&amp;</span> oldVnode<span class="token punctuation">.</span>sel <span class="token operator">===</span> newVnode<span class="token punctuation">.</span>sel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;是同一个节点，需要精细化比较&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;不是同一个节点，暴力 插入新节点，删除旧节点&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建 新虚拟节点 为 DOM节点</span>
    <span class="token comment">// 要操作DOM，所以都要转换成 DOM节点</span>
    <span class="token keyword">let</span> newVnodeElm <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span>newVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> oldVnodeElm <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>elm<span class="token punctuation">;</span>
    <span class="token comment">// 插入 新节点 到 旧节点 之前</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newVnodeElm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 判断newVnodeElm是存在的 在旧节点之前插入新节点</span>
      oldVnodeElm<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>newVnodeElm<span class="token punctuation">,</span> oldVnodeElm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 删除旧节点</span>
    oldVnodeElm<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>oldVnodeElm<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_6-2-createelement-js"><a href="#_6-2-createelement-js" class="header-anchor">#</a> 6.2 createElement.js</h3> <p>创建节点。将vnode虚拟节点创建为DOM节点</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">/**
 * 创建节点。将vnode虚拟节点创建为DOM节点
 * 是孤儿节点，不进行插入操作
 * @param {object} vnode
 */</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token parameter">vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 根据虚拟节点sel选择器属性 创建一个DOM节点，这个节点现在是孤儿节点</span>
  <span class="token keyword">let</span> domNode <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>sel<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 判断是有子节点还是有文本</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    vnode<span class="token punctuation">.</span>text <span class="token operator">!==</span> <span class="token string">&quot;&quot;</span> <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>children <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">||</span> vnode<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 说明没有子节点，内部是文本</span>
    domNode<span class="token punctuation">.</span>innerText <span class="token operator">=</span> vnode<span class="token punctuation">.</span>text<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> vnode<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 说明内部是子节点，需要递归创建节点 </span>
    <span class="token comment">// 遍历数组</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> ch <span class="token keyword">of</span> vnode<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 递归调用 创建出它的DOM，一旦调用createElement意味着创建出DOM了。并且它的elm属性指向了创建出的dom，但是没有上树，是一个孤儿节点</span>
      <span class="token keyword">let</span> chDOM <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 得到 子节点 表示的 DOM节点 递归最后返回的一定是文本节点</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 文本节点 上domNode树</span>
      domNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>chDOM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 补充虚拟节点的elm属性</span>
  vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> domNode<span class="token punctuation">;</span>
  <span class="token comment">// 返回domNode DOM对象</span>
  <span class="token keyword">return</span> domNode<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_6-3-index-js"><a href="#_6-3-index-js" class="header-anchor">#</a> 6.3 index.js</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> h <span class="token keyword">from</span> <span class="token string">&quot;./my_snabbdom/h&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> patch <span class="token keyword">from</span> <span class="token string">&quot;./my_snabbdom/patch&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;container&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> btn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;btn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// const myVnode1 = h(&quot;h1&quot;, {}, &quot;你好&quot;);</span>

<span class="token keyword">const</span> myVnode1 <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;ul&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
  <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;A&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;B&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;C&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;D&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 上树</span>
<span class="token function">patch</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> myVnode1<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_6-4-展示效果"><a href="#_6-4-展示效果" class="header-anchor">#</a> 6.4 展示效果</h3> <p><img src="https://img-blog.csdnimg.cn/20210413213226447.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDk3MjAwOA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> <h2 id="_7-处理新旧节点-是同一个节点-的情况"><a href="#_7-处理新旧节点-是同一个节点-的情况" class="header-anchor">#</a> 7. 处理新旧节点 是同一个节点 的情况</h2> <h3 id="_7-1-分析"><a href="#_7-1-分析" class="header-anchor">#</a> 7.1 分析</h3> <p><img src="https://img-blog.csdnimg.cn/20210414151721159.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDk3MjAwOA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> <h3 id="_7-2-实现-新旧节点text不同情况"><a href="#_7-2-实现-新旧节点text不同情况" class="header-anchor">#</a> 7.2 实现 新旧节点text不同情况</h3> <h4 id="_7-2-1-patch-js"><a href="#_7-2-1-patch-js" class="header-anchor">#</a> 7.2.1 patch.js</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 判断 oldVnode 和 newVnode 是不是同一个节点</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>key <span class="token operator">===</span> newVnode<span class="token punctuation">.</span>key <span class="token operator">&amp;&amp;</span> oldVnode<span class="token punctuation">.</span>sel <span class="token operator">===</span> newVnode<span class="token punctuation">.</span>sel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;是同一个节点，需要精细化比较&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> newVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_7-2-3-patchvnode-js"><a href="#_7-2-3-patchvnode-js" class="header-anchor">#</a> 7.2.3 patchVnode.js</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">patchVnode</span><span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token punctuation">,</span> newVnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 判断新旧 vnode 是否是同一个对象</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode <span class="token operator">===</span> newVnode<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token comment">// 2. 判断 newVndoe 有没有 text 属性</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    newVnode<span class="token punctuation">.</span>text <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span>newVnode<span class="token punctuation">.</span>children <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">||</span> newVnode<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// newVnode 有 text 属性</span>
    <span class="token comment">// 2.1 判断 newVnode 与 oldVnode 的 text 属性是否相同</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newVnode<span class="token punctuation">.</span>text <span class="token operator">!==</span> oldVnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果newVnode中的text和oldVnode的text不同，那么直接让新text写入老elm中即可。</span>
      <span class="token comment">// 如果oldVnode中是children，也会立即消失</span>
      oldVnode<span class="token punctuation">.</span>elm<span class="token punctuation">.</span>innerText <span class="token operator">=</span> newVnode<span class="token punctuation">.</span>text<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// newVnode 没有text属性 有children属性</span>
    <span class="token comment">// 2.2 判断 oldVnode 有没有 children 属性</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>children <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> oldVnode<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// oldVnode有children属性 最复杂的情况，新老节点都有children</span>
 
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// oldVnode没有children属性 说明有text;  newVnode有children属性</span>
      <span class="token comment">// 清空oldVnode的内容</span>
      oldVnode<span class="token punctuation">.</span>elm<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
      <span class="token comment">// 遍历新的vnode虚拟节点的子节点，创建DOM，上树</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> ch <span class="token keyword">of</span> newVnode<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> chDOM <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
        oldVnode<span class="token punctuation">.</span>elm<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>chDOM<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_7-2-2-index-js"><a href="#_7-2-2-index-js" class="header-anchor">#</a> 7.2.2 index.js</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> h <span class="token keyword">from</span> <span class="token string">&quot;./my_snabbdom/h&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> patch <span class="token keyword">from</span> <span class="token string">&quot;./my_snabbdom/patch&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;container&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> btn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;btn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> myVnode1 <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;h1&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;你好&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 上树</span>
<span class="token function">patch</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> myVnode1<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> myVnode2 <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;ul&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
  <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;A&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;B&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;C&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;D&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

btn<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">patch</span><span class="token punctuation">(</span>myVnode1<span class="token punctuation">,</span> myVnode2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_7-3-展示"><a href="#_7-3-展示" class="header-anchor">#</a> 7.3 展示</h3> <p><img src="https://img-blog.csdnimg.cn/2021041416201479.gif#pic_center" alt="在这里插入图片描述"></p> <h2 id="_8-分析-diff算法-更新子节点操作-重要"><a href="#_8-分析-diff算法-更新子节点操作-重要" class="header-anchor">#</a> 8. 分析 diff算法 更新子节点操作（重要）</h2> <p>这里老师ppt有问题，③应该不是新前而是新后
<img src="https://img-blog.csdnimg.cn/20210414191540816.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDk3MjAwOA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"> <img src="https://img-blog.csdnimg.cn/20210415144029858.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDk3MjAwOA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> <h3 id="_8-1-循环四种命中查找"><a href="#_8-1-循环四种命中查找" class="header-anchor">#</a> 8.1 循环四种命中查找</h3> <h4 id="_1-比较-1-新前newstart-与-旧前oldstart"><a href="#_1-比较-1-新前newstart-与-旧前oldstart" class="header-anchor">#</a> 1. 比较 ① 新前newStart 与 旧前oldStart</h4> <p>如果命中①了，patch之后就移动头指针 newStart++  oldStart++
<img src="https://img-blog.csdnimg.cn/20210415165044761.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDk3MjAwOA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkSameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 新前与旧前</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot; ①1 新前与旧前 命中&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 精细化比较两个节点 oldStartVnode现在和newStartVnode一样了</span>
    <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 移动指针，改变指针指向的节点，这表示这两个节点都处理（比较）完了</span>
    oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果没命中就接着比较下一种情况</p> <h4 id="_2-比较-2-新后newend-与-旧后-oldend"><a href="#_2-比较-2-新后newend-与-旧后-oldend" class="header-anchor">#</a> 2. 比较 ② 新后newEnd 与 旧后 oldEnd</h4> <p>如果命中②了，patch后就移动尾指针 newEnd-- oldEnd--
<img src="https://img-blog.csdnimg.cn/20210415165115541.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDk3MjAwOA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkSameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果没命中就接着比较下一种情况</p> <h4 id="_3-比较-3-新后newend-与-旧前oldstart"><a href="#_3-比较-3-新后newend-与-旧前oldstart" class="header-anchor">#</a> 3. 比较 ③ 新后newEnd 与 旧前oldStart</h4> <p>如果命中③了，将 新后newEnd 指向的节点移动到 旧后oldEnd 之后
<img src="https://img-blog.csdnimg.cn/20210415175903445.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDk3MjAwOA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkSameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 新后与旧前</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot; ③3 新后与旧前 命中&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 当③新后与旧前命中的时候，此时要移动节点。移动 新后（旧前） 指向的这个节点到老节点的 旧后的后面</span>
    <span class="token comment">// 移动节点：只要插入一个已经在DOM树上 的节点，就会被移动</span>
    parentElm<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> oldEndVnode<span class="token punctuation">.</span>elm<span class="token punctuation">.</span>nextSibling<span class="token punctuation">)</span><span class="token punctuation">;</span>
    oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="命中3复杂情况举例-倒序"><a href="#命中3复杂情况举例-倒序" class="header-anchor">#</a> 命中③复杂情况举例——倒序</h5> <p><img src="https://img-blog.csdnimg.cn/202104151801013.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDk3MjAwOA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> <p>如果没命中就接着比较下一种情况</p> <h4 id="_4-比较-4-新前newstart-与-旧后oldend"><a href="#_4-比较-4-新前newstart-与-旧后oldend" class="header-anchor">#</a> 4. 比较 ④ 新前newStart 与 旧后oldEnd</h4> <p>如果命中④了，将 新前newStart 指向的节点，移动到 旧前oldStart 之前
<img src="https://img-blog.csdnimg.cn/20210415165916702.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDk3MjAwOA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkSameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 新前与旧后</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot; ④4 新前与旧后 命中&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 当④新前与旧后命中的时候，此时要移动节点。移动 新前（旧后） 指向的这个节点到老节点的 旧前的前面</span>
    <span class="token comment">// 移动节点：只要插入一个已经在DOM树上的节点，就会被移动</span>
    parentElm<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果没命中就表示四种情况都没有命中</p> <h4 id="_5-四种都没命中-遍历oldvnode中的key"><a href="#_5-四种都没命中-遍历oldvnode中的key" class="header-anchor">#</a> 5. 四种都没命中 遍历oldVnode中的key</h4> <p>找到了就 移动位置 移动指针newStart++
<img src="https://img-blog.csdnimg.cn/20210415172642236.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDk3MjAwOA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述">
没找的就是新节点，直接插入所有未处理旧节点之前</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 四种都没有匹配到，都没有命中</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;四种都没有命中&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 寻找 keyMap 一个映射对象， 就不用每次都遍历old对象了</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>keyMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  keyMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// 记录oldVnode中的节点出现的key</span>
  <span class="token comment">// 从oldStartIdx开始到oldEndIdx结束，创建keyMap</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> oldStartIdx<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> oldEndIdx<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      keyMap<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>keyMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 寻找当前项（newStartIdx）在keyMap中映射的序号</span>
<span class="token keyword">const</span> idxInOld <span class="token operator">=</span> keyMap<span class="token punctuation">[</span>newStartVnode<span class="token punctuation">.</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>idxInOld <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果 idxInOld 是 undefined 说明是全新的项，要插入</span>
  <span class="token comment">// 被加入的项（就是newStartVnode这项)现不是真正的DOM节点</span>
  parentElm<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span><span class="token function">createElement</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">)</span><span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// 说明不是全新的项，要移动</span>
  <span class="token keyword">const</span> elmToMove <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">patchVnode</span><span class="token punctuation">(</span>elmToMove<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 把这项设置为undefined，表示我已经处理完这项了</span>
  oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token comment">// 移动，调用insertBefore也可以实现移动。</span>
  parentElm<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>elmToMove<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// newStartIdx++;</span>
newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_8-2-循环结束"><a href="#_8-2-循环结束" class="header-anchor">#</a> 8.2 循环结束</h3> <p>结束后</p> <ol><li>newVnode中还有剩余
新节点中剩余的都 <strong>插入</strong> 旧节点oldEnd后面 或 oldStart之前
<img src="https://img-blog.csdnimg.cn/20210415164815345.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDk3MjAwOA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"> <img src="https://img-blog.csdnimg.cn/20210415165004148.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDk3MjAwOA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></li> <li>oldVnode中还有剩余节点
<img src="https://img-blog.csdnimg.cn/2021041516485799.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDk3MjAwOA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"> <img src="https://img-blog.csdnimg.cn/20210415164931952.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDk3MjAwOA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"> <img src="https://img-blog.csdnimg.cn/2021041516472238.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDk3MjAwOA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 循环结束</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>newStartIdx <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 说明newVndoe还有剩余节点没有处理，所以要添加这些节点</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> newStartIdx<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// insertBefore方法可以自动识别null，如果是null就会自动排到队尾，和appendChild一致</span>
    parentElm<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span><span class="token function">createElement</span><span class="token punctuation">(</span>newCh<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> oldCh<span class="token punctuation">[</span>oldStartIdx<span class="token punctuation">]</span><span class="token punctuation">.</span>elm<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&lt;=</span> oldEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 说明oldVnode还有剩余节点没有处理，所以要删除这些节点</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> oldStartIdx<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> oldEndIdx<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldCh<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      parentElm<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>elm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_9-手写diff更新子节点操作"><a href="#_9-手写diff更新子节点操作" class="header-anchor">#</a> 9. 手写diff更新子节点操作</h2> <h3 id="patchvnode-js"><a href="#patchvnode-js" class="header-anchor">#</a> patchVnode.js</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 2.2 判断 oldVnode 有没有 children 属性</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>children <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> oldVnode<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// oldVnode有children属性 最复杂的情况，新老节点都有children</span>
  <span class="token function">updateChildren</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> oldVnode<span class="token punctuation">.</span>children<span class="token punctuation">,</span> newVnode<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="updatechildren-js"><a href="#updatechildren-js" class="header-anchor">#</a> updateChildren.js</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> createElement <span class="token keyword">from</span> <span class="token string">&quot;./createElement&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> patchVnode <span class="token keyword">from</span> <span class="token string">&quot;./patchVnode&quot;</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * 
 * @param {object} parentElm Dom节点
 * @param {Array} oldCh oldVnode的子节点数组
 * @param {Array} newCh newVnode的子节点数组
 */</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span><span class="token parameter">parentElm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> newCh</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;updateChildren()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">,</span> newCh<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 四个指针</span>
  <span class="token comment">// 旧前</span>
  <span class="token keyword">let</span> oldStartIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// 新前</span>
  <span class="token keyword">let</span> newStartIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// 旧后</span>
  <span class="token keyword">let</span> oldEndIdx <span class="token operator">=</span> oldCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token comment">// 新后</span>
  <span class="token keyword">let</span> newEndIdx <span class="token operator">=</span> newCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token comment">// 指针指向的四个节点</span>
  <span class="token comment">// 旧前节点</span>
  <span class="token keyword">let</span> oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 旧后节点</span>
  <span class="token keyword">let</span> oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 新前节点</span>
  <span class="token keyword">let</span> newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 新后节点</span>
  <span class="token keyword">let</span> newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> keyMap <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&lt;=</span> oldEndIdx <span class="token operator">&amp;&amp;</span> newStartIdx <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;**循环中**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 首先应该不是判断四种命中，而是略过已经加了undefined标记的项</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartVnode <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> oldCh<span class="token punctuation">[</span>oldStartIdx<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndVnode <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> oldCh<span class="token punctuation">[</span>oldEndIdx<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newStartVnode <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> newCh<span class="token punctuation">[</span>newStartIdx<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newEndVnode <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> newCh<span class="token punctuation">[</span>newEndIdx<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkSameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 新前与旧前</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot; ①1 新前与旧前 命中&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 精细化比较两个节点 oldStartVnode现在和newStartVnode一样了</span>
      <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 移动指针，改变指针指向的节点，这表示这两个节点都处理（比较）完了</span>
      oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkSameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 新后与旧后</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot; ②2 新后与旧后 命中&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkSameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 新后与旧前</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot; ③3 新后与旧前 命中&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 当③新后与旧前命中的时候，此时要移动节点。移动 新后（旧前） 指向的这个节点到老节点的 旧后的后面</span>
      <span class="token comment">// 移动节点：只要插入一个已经在DOM树上 的节点，就会被移动</span>
      parentElm<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> oldEndVnode<span class="token punctuation">.</span>elm<span class="token punctuation">.</span>nextSibling<span class="token punctuation">)</span><span class="token punctuation">;</span>
      oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkSameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 新前与旧后</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot; ④4 新前与旧后 命中&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 当④新前与旧后命中的时候，此时要移动节点。移动 新前（旧后） 指向的这个节点到老节点的 旧前的前面</span>
      <span class="token comment">// 移动节点：只要插入一个已经在DOM树上的节点，就会被移动</span>
      parentElm<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span><span class="token punctuation">;</span>
      oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 四种都没有匹配到，都没有命中</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;四种都没有命中&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 寻找 keyMap 一个映射对象， 就不用每次都遍历old对象了</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>keyMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        keyMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">// 记录oldVnode中的节点出现的key</span>
        <span class="token comment">// 从oldStartIdx开始到oldEndIdx结束，创建keyMap</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> oldStartIdx<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> oldEndIdx<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> key <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            keyMap<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>keyMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 寻找当前项（newStartIdx）在keyMap中映射的序号</span>
      <span class="token keyword">const</span> idxInOld <span class="token operator">=</span> keyMap<span class="token punctuation">[</span>newStartVnode<span class="token punctuation">.</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>idxInOld <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果 idxInOld 是 undefined 说明是全新的项，要插入</span>
        <span class="token comment">// 被加入的项（就是newStartVnode这项)现不是真正的DOM节点</span>
        parentElm<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span><span class="token function">createElement</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">)</span><span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 说明不是全新的项，要移动</span>
        <span class="token keyword">const</span> elmToMove <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">patchVnode</span><span class="token punctuation">(</span>elmToMove<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 把这项设置为undefined，表示我已经处理完这项了</span>
        oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
        <span class="token comment">// 移动，调用insertBefore也可以实现移动。</span>
        parentElm<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>elmToMove<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// newStartIdx++;</span>
      newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 循环结束</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>newStartIdx <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 说明newVndoe还有剩余节点没有处理，所以要添加这些节点</span>
    <span class="token comment">// // 插入的标杆</span>
    <span class="token comment">// const before =</span>
    <span class="token comment">//   newCh[newEndIdx + 1] === null ? null : newCh[newEndIdx + 1].elm;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> newStartIdx<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// insertBefore方法可以自动识别null，如果是null就会自动排到队尾，和appendChild一致</span>
      parentElm<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span><span class="token function">createElement</span><span class="token punctuation">(</span>newCh<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> oldCh<span class="token punctuation">[</span>oldStartIdx<span class="token punctuation">]</span><span class="token punctuation">.</span>elm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&lt;=</span> oldEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 说明oldVnode还有剩余节点没有处理，所以要删除这些节点</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> oldStartIdx<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> oldEndIdx<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldCh<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        parentElm<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>elm<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 判断是否是同一个节点</span>
<span class="token keyword">function</span> <span class="token function">checkSameVnode</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> a<span class="token punctuation">.</span>sel <span class="token operator">===</span> b<span class="token punctuation">.</span>sel <span class="token operator">&amp;&amp;</span> a<span class="token punctuation">.</span>key <span class="token operator">===</span> b<span class="token punctuation">.</span>key<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>源码链接 <a href="https://gitee.com/ykang2020/vue_learn" target="_blank" rel="noopener noreferrer">https://gitee.com/ykang2020/vue_learn<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><img src="https://img-blog.csdnimg.cn/20210415222737884.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDk3MjAwOA==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#_0-文章结构预览" title="0. 文章结构预览">0. 文章结构预览</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_0-1-虚拟dom如何被渲染函数-h函数-产生" title="0.1 虚拟DOM如何被渲染函数（h函数）产生">0.1 虚拟DOM如何被渲染函数（h函数）产生</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_0-2-diff算法的原理" title="0.2 diff算法的原理">0.2 diff算法的原理</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_0-3-虚拟dom如何通过diff变成真正的dom" title="0.3 虚拟DOM如何通过diff变成真正的DOM">0.3 虚拟DOM如何通过diff变成真正的DOM</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_1-介绍" title="1. 介绍">1. 介绍</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_1-1-diff算法" title="1.1 diff算法">1.1 diff算法</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_1-2-虚拟dom" title="1.2 虚拟DOM">1.2 虚拟DOM</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_1-3-关系-diff是发生在虚拟dom上的" title="1.3 关系——diff是发生在虚拟DOM上的">1.3 关系——diff是发生在虚拟DOM上的</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_2-snabbdom-简介-及-准备工作" title="2. snabbdom 简介 及 准备工作">2. snabbdom 简介 及 准备工作</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_2-1-简介" title="2.1 简介">2.1 简介</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_2-2-搭建初始环境" title="2.2 搭建初始环境">2.2 搭建初始环境</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_3-h函数的介绍与使用" title="3. h函数的介绍与使用">3. h函数的介绍与使用</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_3-1-介绍" title="3.1 介绍">3.1 介绍</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_3-2-使用h函数-创建虚拟节点" title="3.2 使用h函数 创建虚拟节点">3.2 使用h函数 创建虚拟节点</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_3-3-使用patch函数-将虚拟节点上dom树" title="3.3 使用patch函数 将虚拟节点上DOM树">3.3 使用patch函数 将虚拟节点上DOM树</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_3-4-h函数嵌套使用-得到虚拟dom树-重要" title="3.4 h函数嵌套使用，得到虚拟DOM树（重要）">3.4 h函数嵌套使用，得到虚拟DOM树（重要）</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_4-手写h函数" title="4. 手写h函数">4. 手写h函数</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#vnode-js" title="vnode.js">vnode.js</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#h-js" title="h.js">h.js</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#index-js" title="index.js">index.js</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#效果展示" title="效果展示">效果展示</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_5-手写diff算法准备" title="5. 手写diff算法准备">5. 手写diff算法准备</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_5-1-diff算法原理" title="5.1 diff算法原理">5.1 diff算法原理</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_5-2-手写diff预备" title="5.2 手写diff预备">5.2 手写diff预备</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_6-手写diff-首次上dom树patch-container-myvnode1" title="6. 手写diff——首次上DOM树patch(container, myVnode1)">6. 手写diff——首次上DOM树patch(container, myVnode1)</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_6-0-dom-预备知识" title="6.0 DOM 预备知识">6.0 DOM 预备知识</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_6-1-patch-js" title="6.1 patch.js">6.1 patch.js</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_6-2-createelement-js" title="6.2 createElement.js">6.2 createElement.js</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_6-3-index-js" title="6.3 index.js">6.3 index.js</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_6-4-展示效果" title="6.4 展示效果">6.4 展示效果</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_7-处理新旧节点-是同一个节点-的情况" title="7. 处理新旧节点 是同一个节点 的情况">7. 处理新旧节点 是同一个节点 的情况</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_7-1-分析" title="7.1 分析">7.1 分析</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_7-2-实现-新旧节点text不同情况" title="7.2 实现 新旧节点text不同情况">7.2 实现 新旧节点text不同情况</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_7-3-展示" title="7.3 展示">7.3 展示</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_8-分析-diff算法-更新子节点操作-重要" title="8. 分析 diff算法 更新子节点操作（重要）">8. 分析 diff算法 更新子节点操作（重要）</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_8-1-循环四种命中查找" title="8.1 循环四种命中查找">8.1 循环四种命中查找</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_8-2-循环结束" title="8.2 循环结束">8.2 循环结束</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_9-手写diff更新子节点操作" title="9. 手写diff更新子节点操作">9. 手写diff更新子节点操作</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#patchvnode-js" title="patchVnode.js">patchVnode.js</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#updatechildren-js" title="updateChildren.js">updateChildren.js</a></div></div></div></div> <footer class="footer" data-v-8eb634d6><div class="footer-left-wrap" data-v-8eb634d6><ul class="contact" data-v-8eb634d6><li class="contact-item" data-v-8eb634d6><a href="https://github.com/yk2012" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-8eb634d6><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-8eb634d6><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-8eb634d6></path></svg>
          
        </a></li><li class="contact-item" data-v-8eb634d6><a href="https://vip.163.com/" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-8eb634d6><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mail" data-v-8eb634d6><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" data-v-8eb634d6></path><polyline points="22,6 12,13 2,6" data-v-8eb634d6></polyline></svg>
          
        </a></li><li class="contact-item" data-v-8eb634d6><a href="https://space.bilibili.com/67273812" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-8eb634d6><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-video" data-v-8eb634d6><polygon points="23 7 16 12 23 17 23 7" data-v-8eb634d6></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2" data-v-8eb634d6></rect></svg>
          
        </a></li><li class="contact-item" data-v-8eb634d6><a href="https://blog.csdn.net/weixin_44972008" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-8eb634d6><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-globe" data-v-8eb634d6><circle cx="12" cy="12" r="10" data-v-8eb634d6></circle><line x1="2" y1="12" x2="22" y2="12" data-v-8eb634d6></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" data-v-8eb634d6></path></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-8eb634d6><ul class="copyright" data-v-8eb634d6><li class="copyright-item" data-v-8eb634d6><a href="https://gitee.com/ykang2020" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-8eb634d6>YK菌</a></li><li class="copyright-item" data-v-8eb634d6>YK | Copyright © 2021</li></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.aa55ed40.js" defer></script><script src="/assets/js/6.74f99adc.js" defer></script><script src="/assets/js/3.92880c3b.js" defer></script><script src="/assets/js/15.a493639f.js" defer></script>
  </body>
</html>
